# Agent Notes

This repository is the "otak-conference" real-time translation conference app.
Frontend is React + TypeScript + Tailwind, backend is Cloudflare Workers with Durable Objects.

## Structure
- src/: frontend TypeScript sources (main entry, hooks, components, utils)
- public/: static assets + build output (bundle.js, styles.css)
- server/: worker entry + room durable object
- legacy/: previous monolithic implementations (kept for reference)
- tests/: unit + integration tests

## Build and Dev
- Install deps: npm install
- Build: npm run build
  - Generates public/bundle.js and public/styles.css (do not edit manually)
- Local frontend (HMR): npm run dev:frontend (Vite, HTTP, no mic access)
- Local frontend (static): npm run dev:frontend:static (build + http-server)
- HTTPS dev (mic access): npm run dev:tunnel (static build via cloudflared)
- Worker dev: npm run dev

## Tests
- Unit tests: npm test
- API integration: npm run test:api
- Gemini integration: npm run test:integration
- All tests: npm run test:all
- Live audio test script: `tests/scripts/test-live-api-mp3.js` runs 16 patterns by default; best default settings are chunk=0.25s, delay=80ms, trailing silence=1s, idleMs=2000ms (use `LIVE_RESPONSE_MODE=audio`).

## Evals
- Datasets: `tests/evals/translation-ja-en.json` and `tests/evals/translation-ja-vi.json` (references + keywords).
- Audio fixtures: `tests/assets/audio/tts` (`sier-01-zephyr.wav`, etc.).
- Runner: `node tests/scripts/eval-translation-audio.js` (requires `GEMINI_API_KEY`); defaults to 3 items (1/10) unless `EVAL_LIMIT` is set.
- Analysis: `node tests/scripts/analyze-eval-output.js` generates a summary + worst cases into `tests/evals/output/translation-ja-<target>.analysis.json`.
- Output: `tests/evals/output/translation-ja-<target>.json`.
- Audio prep tuning: `node tests/scripts/tune-audio-prep.js` writes `tests/evals/output/audio-prep-tuning.json`.
- Current best audio prep (40-item tuning grid, raw input minimized): `EVAL_TARGET_RMS=0.09` and `EVAL_LEAD_SILENCE_SEC=0.4` (avg F1 ~0.746, avg latency ~2.19s, lowInputRaw 17/40, lowInputNormalized 4/40).
- Key env vars: `EVAL_TARGET` (en|vi), `EVAL_VOICES`, `EVAL_IDS`, `EVAL_LIMIT`, `EVAL_RESPONSE_MODE`, `EVAL_CHUNK_SECONDS`, `EVAL_CHUNK_DELAY_MS`, `EVAL_TRAILING_SILENCE_SEC`, `EVAL_LEAD_SILENCE_SEC`, `EVAL_PREP_TRAILING_SILENCE_SEC`, `EVAL_DUPLICATE_THRESHOLD_SEC`, `EVAL_NORMALIZE_AUDIO`, `EVAL_TARGET_RMS`, `EVAL_MIN_GAIN`, `EVAL_MAX_GAIN`, `EVAL_SHORT_GAIN_BOOST`, `EVAL_FIXED_GAIN`, `EVAL_IDLE_MS`, `EVAL_IDLE_MODE`, `EVAL_INPUT_LANGUAGE_CODE`, `EVAL_NORMALIZE_TRANSCRIPTION`, `EVAL_GLOSSARY_MODE`, `EVAL_GLOSSARY_TERMS`, `EVAL_MODEL`, `EVAL_API_VERSION`, `EVAL_SESSION_PER_ITEM`, `EVAL_CONCURRENCY`, `EVAL_ITEM_CONCURRENCY`, `EVAL_TEXT_MODEL`, `EVAL_TEXT_API_VERSION`, `EVAL_TEXT_FALLBACK`, `EVAL_FORCE_TEXT_FALLBACK`, `EVAL_MIN_OUTPUT_RATIO`, `EVAL_MIN_OUTPUT_TOKENS`.

## Environment
- .env: GEMINI_API_KEY is required for Gemini integration tests
- Build can override CLOUDFLARE_WORKER_DOMAIN if needed

## Conventions
- Keep frontend changes in src/ and backend changes in server/
- Update tests and docs when changing public API or structure
- Avoid editing files under public/ that are generated by the build

## Project Notes (compressed from former .roorules)
- Frontend entry flow: `src/main.tsx` -> `useConferenceApp` (re-exported from `src/hooks.ts`) -> `ConferenceApp` in `src/components/ConferenceApp.tsx` (re-exported from `src/components.tsx`).
- Core hook: `useConferenceApp` in `src/conference/useConferenceApp.ts` owns state, WebRTC, WebSocket, and Gemini Live Audio orchestration.
- Conference hooks: `src/conference/` groups audio, signaling, media, gemini, persistence, and state modules.
- UI: `src/components/ConferenceApp.tsx` renders controls/modals; `src/components/` holds panels/modals; `src/generative-art-background-webgl.tsx` wires the WebGL background using `src/generative-art-webgl/`.
- Translation: `src/gemini-live-audio/` holds session/stream/capture/processing/send/message handlers; `src/gemini-live-audio.ts` re-exports the public surface.
- Gemini constraint: use `models/gemini-2.5-flash-native-audio-preview-12-2025` with AUDIO-only response modality (TEXT+AUDIO causes INVALID_ARGUMENT).
- Retranslation: `src/text-retranslation-service.ts` uses Gemini Flash for text back-translation (separate from live audio).
- Prompts: `src/translation-prompts/` holds strict translation-only system prompts and language configs; `src/translation-prompts.ts` re-exports.
- Backend: `server/worker.js` + `server/room-handler.js` provide WebSocket signaling; room capacity is max 2 participants.
- Signaling URL: `wss://${CLOUDFLARE_WORKER_DOMAIN}/ws?room=${roomId}`; UI share links use `?roomId=` on the page URL.
- Settings persistence: `src/conference/useConferencePersistence.ts` stores API key, username, language, device IDs, playback, noise filter, and usage in localStorage.
- Audio pipeline: AudioWorklet capture/playback is in `public/audio-capture-processor.js` and `public/pcm-processor.js`.
- Input normalization: `src/gemini-live-audio/audioSend.ts` normalizes input RMS to ~0.09 (min gain 0.6, max gain 2.2) before sending to Gemini; silence gating is RMS-based.
- Debug: `src/debug-utils.ts` gates logs behind `?debug=true` in URL.
- Build/deploy: GitHub Pages serves frontend; Cloudflare Workers handles signaling; `wrangler.toml` points to `server/worker.js`.
