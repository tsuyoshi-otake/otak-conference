# Agent Notes

This repository is the "otak-conference" real-time translation conference app.
Frontend is React + TypeScript + Tailwind, backend is Cloudflare Workers with Durable Objects.

## Structure
- src/: frontend TypeScript sources (main entry, hooks, components, utils)
- public/: static assets + build output (bundle.js, styles.css)
- server/: worker entry + room durable object
- legacy/: previous monolithic implementations (kept for reference)
- tests/: unit + integration tests

## Build and Dev
- Install deps: npm install
- Build: npm run build
  - Generates public/bundle.js and public/styles.css (do not edit manually)
- Local frontend: npm run dev:frontend (HTTP, no mic access)
- HTTPS dev (mic access): npm run dev:tunnel (requires cloudflared)
- Worker dev: npm run dev

## Tests
- Unit tests: npm test
- API integration: npm run test:api
- Gemini integration: npm run test:integration
- All tests: npm run test:all

## Environment
- .env: GEMINI_API_KEY is required for Gemini integration tests
- Build can override CLOUDFLARE_WORKER_DOMAIN if needed

## Conventions
- Keep frontend changes in src/ and backend changes in server/
- Update tests and docs when changing public API or structure
- Avoid editing files under public/ that are generated by the build

## Project Notes (compressed from former .roorules)
- Frontend entry flow: `src/main.tsx` -> `useConferenceApp` in `src/hooks.ts` -> `ConferenceApp` in `src/components.tsx`.
- Core hook: `useConferenceApp` in `src/hooks.ts` owns state, WebRTC, WebSocket, and Gemini Live Audio orchestration.
- UI: `src/components.tsx` is the main `ConferenceApp` rendering all controls/modals; `src/generative-art-background-webgl.tsx` provides the WebGL particle background.
- Translation: `src/gemini-live-audio.ts` manages Gemini Live Audio sessions (AUDIO-only modality), with 16kHz input / 24kHz output contexts and chunked ~1.5s audio send.
- Gemini constraint: use `models/gemini-2.5-flash-preview-native-audio-dialog` with AUDIO-only response modality (TEXT+AUDIO causes INVALID_ARGUMENT).
- Retranslation: `src/text-retranslation-service.ts` uses Gemini Flash for text back-translation (separate from live audio).
- Prompts: `src/translation-prompts.ts` holds strict translation-only system prompts and language configs.
- Backend: `server/worker.js` + `server/room-handler.js` provide WebSocket signaling; room capacity is max 2 participants.
- Signaling URL: `wss://${CLOUDFLARE_WORKER_DOMAIN}/ws?room=${roomId}`; UI share links use `?roomId=` on the page URL.
- Settings persistence: `src/hooks.ts` stores API key, username, language, device IDs, playback, noise filter, and usage in localStorage.
- Audio pipeline: AudioWorklet capture/playback is in `public/audio-capture-processor.js` and `public/pcm-processor.js`.
- Debug: `src/debug-utils.ts` gates logs behind `?debug=true` in URL.
- Build/deploy: GitHub Pages serves frontend; Cloudflare Workers handles signaling; `wrangler.toml` points to `server/worker.js`.
